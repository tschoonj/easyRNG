version: 1.0.{build}

environment:
  matrix:
    - compiler: msvc_msys2
      ARCH: x64
      MSYS2_ARCH: x86_64
      MSYS2_DIR: msys64
      MSYSTEM: MINGW64
      BUILDSYSTEM: meson
    - compiler: msvc_msys2
      ARCH: x64
      MSYS2_ARCH: x86_64
      MSYS2_DIR: msys64
      MSYSTEM: MINGW64
      BUILDSYSTEM: autotools

before_build:
    - set PATH=C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%
    - bash -lc "pacman -Rs --noconfirm --ask 20 `pacman -Qsq mingw-w64-i686`" # get rid of all 32-bit packages
    - bash -lc "pacman -R --noconfirm --ask 20 mingw-w64-x86_64-gcc-ada mingw-w64-x86_64-gcc-objc" # remove gcc packages that no longer exist in the repo
    - bash -lc "for i in {1..3}; do pacman -Syyuu --force --ask 20 --noconfirm && break || sleep 15; done"
    - bash -lc "for i in {1..3}; do pacman --noconfirm -Su mingw-w64-%MSYS2_ARCH%-{gcc,gsl,libtool,meson} automake autoconf make && break || sleep 15; done"
    - bash -lc "cd \"$APPVEYOR_BUILD_FOLDER\" && exec ./appveyor-before-build.sh"

build_script:
    - cd %APPVEYOR_BUILD_FOLDER%
    - echo %cd%
    - dir
    - bash -lc "cd \"$APPVEYOR_BUILD_FOLDER\" && exec ./appveyor-build.sh"
    #- perl -i".bak" -pe "s/^test -n \".DJDIR\"/#$&/" configure
    #- bash -lc "./configure && make && make check && make distcheck"

branches:
  only:
    - master

